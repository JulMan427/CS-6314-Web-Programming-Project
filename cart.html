<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cart</title>
  <link rel="stylesheet" href="mystyle.css">
  <script src="script.js" defer></script>
  <script>
    var cart = null;
    var pax = { adults: 0, children: 0, infants: 0 };

    document.addEventListener("DOMContentLoaded", function () {
      cart = getCart();
      if (!cart || !cart.kind) {
        document.getElementById("cartTableWrap").innerHTML = "<p>Cart is empty.</p>";
        return;
      }
      pax = cart.pax || { adults: 0, children: 0, infants: 0 };
      renderCart();
      buildPassengerForm();
    });

    function renderCart() {
      var wrap = document.getElementById("cartTableWrap");
      var html = "";
      html += '<table class="table">';
      html += '<thead><tr><th>Leg</th><th>Flight</th><th>Route</th><th>Departure</th><th>Arrival</th></tr></thead>';
      html += "<tbody>";

      function addRow(f, label) {
        html += "<tr>";
        html += "<td>" + label + "</td>";
        html += "<td>" + f.flightId + "</td>";
        html += "<td>" + f.origin + " \u2192 " + f.destination + "</td>";
        html += "<td>" + f.departureDate + " " + f.departureTime + "</td>";
        html += "<td>" + f.arrivalDate + " " + f.arrivalTime + "</td>";
        html += "</tr>";
      }

      if (cart.out) addRow(cart.out, "Depart");
      if (cart.back) addRow(cart.back, "Return");

      html += "</tbody></table>";
      wrap.innerHTML = html;

      var base = (cart.out ? cart.out.price : 0) + (cart.back ? cart.back.price : 0);
      var total = ticketTotal(base, pax.adults, pax.children, pax.infants);

      document.getElementById("cartSummary").innerHTML =
        '<p class="note">Passengers: ' + pax.adults + " adults, " + pax.children + " children, " + pax.infants + ' infants</p>' +
        "<p><strong>Total Price:</strong> $" + total.toFixed(2) + "</p>";
    }

    function buildPassengerForm() {
      var total = pax.adults + pax.children + pax.infants;
      var box = document.getElementById("passengersBox");
      var html = "<h3>Passenger Details</h3>";
      var i;

      for (i = 1; i <= total; i++) {
        html += '<fieldset style="margin-bottom:12px;">';
        html += "<legend>Passenger " + i + "</legend>";
        html += '<label>First Name <input required id="p' + i + '_fn"></label>';
        html += '<label>Last Name <input required id="p' + i + '_ln"></label>';
        html += '<label>Date of Birth <input type="date" required id="p' + i + '_dob"></label>';
        html += '<label>SSN <input required id="p' + i + '_ssn" placeholder="123-45-6789"></label>';
        html += "</fieldset>";
      }

      html += '<button type="button" onclick="bookNow()">Book Flight(s)</button> ';
      html += '<button type="button" onclick="downloadBookingsJSON()">Download Bookings JSON</button>';
      box.innerHTML = html;
    }

    function bookNow() {
      var paxCount = pax.adults + pax.children + pax.infants;
      var paxList = [];
      var i;

      for (i = 1; i <= paxCount; i++) {
        var fn = document.getElementById("p" + i + "_fn").value.trim();
        var ln = document.getElementById("p" + i + "_ln").value.trim();
        var dob = document.getElementById("p" + i + "_dob").value;
        var ssn = document.getElementById("p" + i + "_ssn").value.trim();
        if (!fn || !ln || !dob || !ssn) {
          alert("Please complete all passenger fields.");
          return;
        }
        paxList.push({ firstName: fn, lastName: ln, dob: dob, ssn: ssn });
      }

      // Assign booking numbers
      var userId = uniqueId("USER");
      var outBk = uniqueId("BOOK");
      var backBk = cart.kind === "round" ? uniqueId("BOOK") : null;

      // Update seats in inventory
      var flights = JSON.parse(localStorage.getItem("flightsInventory") || "[]");
      var need = paxCount;

      function dec(fid) {
        var idx = -1;
        var j;
        for (j = 0; j < flights.length; j++) {
          if (flights[j].flightId === fid) { idx = j; break; }
        }
        if (idx >= 0) {
          var current = flights[idx].availableSeats;
          flights[idx].availableSeats = Math.max(0, current - need);
        }
      }

      if (cart.out) dec(cart.out.flightId);
      if (cart.back) dec(cart.back.flightId);
      updateFlightsInventory(flights);

      // Save booking record(s)
      var records = [];

      if (cart.out) {
        records.push({
          userId: userId, bookingNumber: outBk, flightId: cart.out.flightId,
          origin: cart.out.origin, destination: cart.out.destination,
          departureDate: cart.out.departureDate, arrivalDate: cart.out.arrivalDate,
          departureTime: cart.out.departureTime, arrivalTime: cart.out.arrivalTime,
          passengers: paxList
        });
      }
      if (cart.back) {
        records.push({
          userId: userId, bookingNumber: backBk, flightId: cart.back.flightId,
          origin: cart.back.origin, destination: cart.back.destination,
          departureDate: cart.back.departureDate, arrivalDate: cart.back.arrivalDate,
          departureTime: cart.back.departureTime, arrivalTime: cart.back.arrivalTime,
          passengers: paxList
        });
      }

      var k;
      for (k = 0; k < records.length; k++) saveBooking(records[k]);

      var msg = "Booked! Booking numbers:\n";
      for (k = 0; k < records.length; k++) {
        msg += records[k].bookingNumber + (k < records.length - 1 ? ", " : "");
      }
      alert(msg);

      clearCart();
      location.reload();
    }
  </script>
</head>
<body onload="showDateTime()">
  <header>
    <h1>Cart</h1>
    <p id="datetime"></p>
  </header>

  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="stays.html">Stays</a></li>
      <li><a href="flights.html">Flights</a></li>
      <li><a href="cars.html">Cars</a></li>
      <li><a href="cruises.html">Cruises</a></li>
      <li><a href="contact-us.html">Contact Us</a></li>
      <li><a href="cart.html">Cart</a></li>
    </ul>
  </nav>

  <main>
    <div class="sidebar">
      <h2>Sidebar</h2>
    </div>

    <div class="main-content">
      <div id="cartTableWrap"></div>
      <div id="cartSummary" style="margin-top: 10px;"></div>
      <div id="passengersBox" style="margin-top: 1em;"></div>
    </div>
  </main>

  <footer>
    <button onclick="increaseFont()">Increase Font</button>
    <button onclick="decreaseFont()">Decrease Font</button>
    <button onclick="changeBackground()">Change Background</button>
  </footer>
</body>
</html>
